# Code to produce the coefficients for computing the gamma function using the Lanczos approximation.
# Thanks to Paul Godfrey at https://www.numericana.com/answer/info/godfrey.htm.
# With g=9 it computes exactly the (textual) values in Godfrey, as used in fac.go.

g = 9
size = g+2

# D ===================

op diag v =
	d = count v
	d d rho flatten v @, d rho 0

# OEIS https://oeis.org/A002457: a(n) = (2n+1)!/n!^2.
op A2457 n = (!1+2*n)/(!n)**2

D = diag 1, -A2457@ -1+iota size-1

# B ===================

# Binomial coefficients, with tweaks.

n = 2*size
p = n n rho 1 # Will hold Pascal's triangle.

i = 1
p[1] = n rho 0
p[1;1]=1
:while (i=i+1) <= n
	k = 1
	:while (k=(k)+1) < i
		p[i;k] = p[i-1;k]+p[i-1;k-1]
	:end
	p[i;k+iota wid]=(wid=n-k) rho 0 # Set rest of row to zero.
:end

# Put an extra column of 1s on the right
pp =  (n) (n+ 1) rho 1
pp[;1+iota n] = p
p=transp pp

# Take alternate rows
i = -1
data = ()
:while n>= i=i+2
	row = p[i]
	offset = 0
	:if i > 4
		offset = floor (i-2)/2
	:end
	row = row[offset+iota size]
	data = data, row
:end

# Now flip some signs
data = size size rho data * (-1+2*(iota size*size)&1)
data[1;]=size rho 1 # Except for the first row.
B = size size rho data

# C ===================

# The vector is a list of coefficients: c0 c1 c2.... calculated by taking even columns
# of a matrix of Chebyshev coefficients (Abramowitz & Stegun Table 22.3) using
# the recurrence relation: T0(ùë•)=1; T1(ùë•)=ùë•; T‚Çô‚Çä‚ÇÅ(ùë•)=2xT‚Çô(ùë•)-T‚Çô‚Çã‚ÇÅ(ùë•).
tsize = -1+2*size # Double size as we take alternate rows.

op timesx a = tsize take 0, a # Adding a slot at left of series multiplies by x.

cache = 100 rho 'x' # Calculating T this way is deeply recursive, so cache computed values.

op T n =
	n == 0: tsize take 1
	n == 1: tsize take 0 1
	cache[1+n] !== 'x': cache[1+n]
	cache[1+n] = (2 * (timesx T n-1)) - (T n-2)

op gen x = (tsize rho 1 0) sel T 2*x

data =  flatten gen@-1+iota tsize
data[1] = 0.5

C=size size rho data

# F ===================

op gamma n = # # n guaranteed to be an integer plus 1/2.
	n = n - 0.5
	(sqrt pi) * (!2*n) / (!n)*4**n

op fn z = ((sqrt 2) / pi) * (gamma(z+.5)) * (**(z+g+.5)) * (z+g+0.5)**-(z+0.5)

F = size 1 rho  fn@ -1+iota size

# ===================

# And now the final thunderclap: multiply it all together.
'%.22g' text (D+.*B+.*C)+.*F



